@model PetClinicSystem.Models.Appointment

@{
    ViewData["Title"] = "Appointment Details";
    ViewData["ActivePage"] = "Appointments";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="page-title">
                <i class="fas fa-calendar-check me-2"></i>@ViewData["Title"]
            </h2>
            <div class="text-muted small">
                Scheduled on @Model.CreatedDate?.ToString("MMM dd, yyyy")
            </div>
        </div>
        <div class="col-md-6 text-end">
            @if (Model.Status != "Completed" && Model.Status != "Cancelled")
            {
                <a asp-action="Edit" asp-route-id="@Model.AppointmentId" class="btn btn-primary me-2">
                    <i class="fas fa-edit me-2"></i>Edit
                </a>
                <button class="btn btn-outline-danger me-2 cancel-btn" data-id="@Model.AppointmentId">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
            }
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Appointment Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Date & Time</div>
                                <div>@Model.AppointmentDate.ToString("MMM dd, yyyy h:mm tt")</div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Duration</div>
                                <div>@(Model.Duration?.ToString() ?? "30") minutes</div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Status</div>
                                <div>
                                    <span class="badge bg-@(Model.Status == "Completed" ? "success" :
                                                                                              Model.Status == "Cancelled" ? "danger" : "info")">
                                        @Model.Status
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Reason</div>
                                <div>@Model.Reason</div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Notes</div>
                                <div>@(string.IsNullOrEmpty(Model.Notes) ? "None" : Model.Notes)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-md me-2"></i>Veterinarian Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        @if (!string.IsNullOrEmpty(Model.Vet?.FirstName))
                        {
                            <img src="/images/default-avatar.png" class="avatar-lg rounded-circle me-3" alt="No photo available">

                        }
                        <div>
                            <h5 class="mb-0">Dr. @Model.Vet?.FirstName @Model.Vet?.LastName</h5>
                            <div class="text-muted">@Model.Vet?.Role</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Contact</div>
                                <div>@Model.Vet?.Phone</div>
                                <div>@Model.Vet?.Email</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Availability</div>
                                <div>@Model.Vet?.Appointments</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-paw me-2"></i>Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        @if (!string.IsNullOrEmpty(Model.Patient?.PhotoPath))
                        {
                            <img src="@Model.Patient.PhotoPath" width="80" height="80" class="avatar-lg rounded-circle me-3" alt="@Model.Patient.Name">
                        }
                        <div>
                            <h5 class="mb-0">@Model.Patient?.Name</h5>
                            <div class="text-muted">@Model.Patient?.Species | @Model.Patient?.Breed</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Age</div>
                                <div>
                                    @if (Model.Patient?.DateOfBirth.HasValue ?? false)
                                    {
                                        var dob = Model.Patient.DateOfBirth.Value;
                                        var today = DateOnly.FromDateTime(DateTime.Today);
                                        var age = today.Year - dob.Year;

                                        if (dob > today.AddYears(-age))
                                        {
                                            age--;
                                        }

                                        <span>@age years</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Unknown</span>
                                    }
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Gender</div>
                                <div>@Model.Patient?.Gender</div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Allergies</div>
                                <div>@(string.IsNullOrEmpty(Model.Patient?.Allergies) ? "None reported" : Model.Patient.Allergies)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-bold">Owner</div>
                                <div>@Model.Patient?.Owner?.FirstName @Model.Patient?.Owner?.LastName</div>
                            </div>
                            <div class="mb-3">
                                <div class="fw-bold">Contact</div>
                                <div>@Model.Patient?.Owner?.Phone</div>
                                <div>@Model.Patient?.Owner?.Email</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.Consultations?.Any() ?? false)
            {
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-notes-medical me-2"></i>Consultation Notes
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var consultation in Model.Consultations)
                        {
                            <div class="consultation-note mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong>@consultation.ConsultationDate?.ToString("MMM dd, yyyy")</strong>
                                    <span class="badge bg-info">Consultation</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Diagnosis:</strong> @(string.IsNullOrEmpty(consultation.Diagnosis) ? "None" : consultation.Diagnosis)
                                </div>
                                <div>
                                    <strong>Notes:</strong> @(string.IsNullOrEmpty(consultation.Notes) ? "None" : consultation.Notes)
                                </div>
                                <div class="mt-2">
                                    <a asp-controller="Consultations" asp-action="Details" asp-route-id="@consultation.ConsultationId" class="btn btn-sm btn-outline-primary">
                                        View Details
                                    </a>
                                </div>
                            </div>
                            <hr>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cancel appointment button handler
        $('.cancel-btn').click(function() {
            var id = $(this).data('id');
            Swal.fire({
                title: 'Cancel Appointment',
                text: "Are you sure you want to cancel this appointment?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, cancel it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Appointments/Cancel/' + id, function() {
                        Swal.fire(
                            'Cancelled!',
                            'The appointment has been cancelled.',
                            'success'
                        ).then(() => location.reload());
                    }).fail(function() {
                        Swal.fire(
                            'Error!',
                            'Something went wrong.',
                            'error'
                        );
                    });
                }
            });
        });
    </script>
}